<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="preferences-data.html">
<link rel="import" href="address-item-details.html">

<dom-module id="address-item">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host(:not([is-narrow])) .list-item {
        box-shadow: var(--shadow-elevation-2dp_-_box-shadow);
        margin: 8px;
      }
      :host([is-narrow]) .list-item {
        border-top: 1px solid var(--paper-grey-400);
      }
      paper-item {
        --paper-item-focused-before: {
          background-color: white;
        }
      }
      .list-item {
        background-color: white;
      }
    </style>

    <preferences-data btc-format="{{btcFormat}}"></preferences-data>

    <div class="list-item">
      <paper-item on-click="_toggleDetails">
        <paper-item-body two-line>
          <div>[[address]]</div>
          <div secondary class="primary-text">
            <span class="bold medium-text">[[_formatBalance(btcFormat, addressData)]]</span>
            <span>([[_formatPrice(priceData, addressData)]])</span>
          </div>
        </paper-item-body>
        <paper-icon-button icon="[[_getArrowIcon(isDetailsOpen)]]"></paper-icon-button>
      </paper-item>
      <iron-collapse opened="[[isDetailsOpen]]">
        <address-item-details
          address=[[address]]
          address-data=[[addressData]]
          btc-format="[[btcFormat]]"
          on-open-delete-dialog="_openDeleteDialog">
        </address-item-details>
      </iron-collapse>
    </div>

    <paper-dialog
      id="deleteDialog"
      no-overlap="[[!isNarrow]]"
      horizontal-align="[[_horizontalAlign(isNarrow)]]"
      vertical-align="[[_verticalAlign(isNarrow)]]">
      <h2>Delete address?</h2>
      <div>
        <paper-button raised dialog-dismiss>Cancel</paper-button>
        <paper-button raised dialog-confirm on-click="_delete">Confirm</paper-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    class AddressItem extends Polymer.Element {
      static get is() { return 'address-item' }

      static get properties() {
        return {
          address: String,
          addressData: Object,
          isDetailsOpen: {
            type: Boolean,
            value: false,
          },
          isNarrow: {
            type: Boolean,
            reflectToAttribute: true,
          },
          priceData: Object,
        }
      }

      _horizontalAlign(isNarrow) {
        return isNarrow ? '' : 'center'
      }

      _verticalAlign(isNarrow) {
        return isNarrow ? '' : 'top'
      }

      _openDeleteDialog(e) {
        if (this.isNarrow) {
          this.$.deleteDialog.positionTarget = null
        } else {
          this.$.deleteDialog.positionTarget = e.detail.deleteButton
        }
        this.$.deleteDialog.open()
      }

      _delete() {
        this.dispatchEvent(new CustomEvent('delete', {detail: {address: this.address}}))
      }

      _formatBalance(btcFormat, addressData) {
        if (!(btcFormat && addressData && addressData[this.address])) {
          return '- ' + (btcFormat ? btcFormat.name : 'BTC')
        }
        return utils.formatBtc({btcFormat, amount: addressData[this.address].balance})
      }

      _formatPrice(priceData, addressData) {
        if (!(priceData && addressData && addressData[this.address])) {
          return '- USD'
        }
        const amount = addressData[this.address].balance / 100000000 * priceData.USD
        return utils.formatFiat({amount})
      }

      _getArrowIcon() {
        return this.isDetailsOpen ? 'expand-more' : 'chevron-right'
      }

      _toggleDetails() {
        this.isDetailsOpen = !this.isDetailsOpen
      }
    }

window.customElements.define(AddressItem.is, AddressItem)
  </script>
</dom-module>
