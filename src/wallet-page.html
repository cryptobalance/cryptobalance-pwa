<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="wallet-navigator.html">
<link rel="import" href="address-item.html">
<link rel="import" href="preferences-data.html">

<script src="../bower_components/moment/min/moment.min.js"></script>
<script src="../browserify-libs.js"></script>

<dom-module id="wallet-page">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      paper-icon-button {
        --paper-icon-button-ink-color: var(--app-primary-color);
      }
      footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        color: var(--app-primary-color);
        background-color: var(--app-secondary-color);
        padding: 8px;
        text-align: center;
      }
      footer span {
        margin-left: 5px;
      }
      .toolbar .amounts {
        text-shadow: 2px 2px 0 rgba(0, 0, 0, 0.14);
      }
    </style>

    <preferences-data btc-format="{{btcFormat}}" currency="{{currency}}"></preferences-data>

    <div class="layout horizontal">
      <!-- Always visible navigation for non narrow screens -->
      <dom-if if="[[!isNarrow]]">
        <template>
          <wallet-navigator></wallet-navigator>
        </template>
      </dom-if>

      <!-- Main content -->
      <div class="flex">
        <div class="toolbar bg-white center-text layout horizontal around-justified center">
          <a href="[[rootPath]]add-address">
            <paper-button raised>add address</paper-button>
          </a>
          <div class="primary-text amounts">
            <span class="large-text">[[_formatBalance(btcFormat, storedAddresses.*, addressData)]]</span>
            <br>
            <span class="medium-text">[[_formatPrice(priceData, storedAddresses.*, addressData)]]</span>
          </div>
          <div class="small-text">
            <span>Last update</span>
            <br>
            <span>[[_formatUpdatedTime(updatedAt)]]</span>
          </div>
        </div>

        <div class="list" tabindex="0">
          <template is="dom-repeat" items="{{storedAddresses}}">
            <address-item
              address="{{item}}"
              address-data="[[_addressData(item.id, addressData)]]"
              price-data="[[priceData]]"
              is-narrow="[[isNarrow]]"
              on-delete="_deleteAddress">
            </address-item>
          </template>
          <dom-if if="[[!storedAddresses.length]]">
            <template>
              <h2 class="center-text">This group is empty.</h2>
            </template>
          </dom-if>
        </div>
      </div>
    </div>

    <footer>
      <iron-icon class="big-icon" src="https://www.cryptocompare.com/media/19633/btc.png"></iron-icon>
      <span>[[_formatCurrentPrice(priceData)]]</span>
    </footer>

    <iron-ajax id="addressRequest"></iron-ajax>
    <iron-ajax auto id="priceRequest" url="[[_priceRequestUrl(currency)]]" last-response="{{priceData}}"></iron-ajax>
    <app-localstorage-document id="updatedAt" key="updatedAt" data="{{updatedAt}}"></app-localstorage-document>
    <app-localstorage-document id="addressData" key="addressData" data="{{addressData}}"></app-localstorage-document>
    <app-localstorage-document id="priceData" key="priceData" data="{{priceData}}"></app-localstorage-document>
    <app-localstorage-document id="storedAddresses" key="storedAddresses" data="{{storedAddresses}}"></app-localstorage-document>
  </template>

  <script>
    class WalletPage extends Polymer.Element {
      static get is() { return 'wallet-page' }

      static get properties() {
        return {
          addressData: Object,
          btcFormat: Object,
          isNarrow: Boolean,
          priceData: Object,
          shouldUpdate: {
            type: Boolean,
            value: false,
            notify: true,
            observer: '_shouldUpdate',
          },
          storedAddresses: {
            type: Array,
            value: () => [],
            notify: true,
          },
          updatedAt: {
            type: Date,
            value: null,
          },
        }
      }

      ready() {
        super.ready()

        const storagePromises = [
          this.$.addressData.transactionsComplete,
          this.$.storedAddresses.transactionsComplete,
          this.$.updatedAt.transactionsComplete,
        ]

        Promise.all(storagePromises)
          .then(() => {
            const withinTimeLimit = this.updatedAt
              ? moment(this.updatedAt).add(1, 'minute').isAfter(moment(), 'minute')
              : false

            if (!withinTimeLimit) {
              this.updateAllAddresses()
            }
          })
      }

      _priceRequestUrl(currency) {
        return 'https://min-api.cryptocompare.com/data/price?fsym=BTC&tsyms=' + currency
      }

      _addressData(address, addressData) {
        return addressData ? addressData[address] : null
      }

      _shouldUpdate(newValue) {
        if (newValue === true) {
          this.updateAllAddresses()
          this.shouldUpdate = false
        }
      }

      _deleteAddress(e) {
        const index = this.storedAddresses.findIndex((address) => address.id === e.detail.id)
        if (index > -1) {
          this.splice('storedAddresses', index, 1)
        }
      }

      updateAllAddresses() {
        this.updateAddresses({addresses: this.storedAddresses.map((address) => address.id)})
      }

      updateAddresses({addresses, responses = []}) {
        if (addresses.length === 0) {
          return
        }

        const addressParam = addresses.splice(0, 3).join(';')
        const addressRequest = this.$.addressRequest
        addressRequest.url = `https://api.blockcypher.com/v1/btc/main/addrs/${addressParam}/balance`

        addressRequest.generateRequest().completes
          .then((e) => {
            responses.push(e.parseResponse())
            if (addresses.length === 0) {
              this.addressData = this.parseAddressData(responses)
              this.updatedAt = new Date()
            } else {
              setTimeout(() => this.updateAddresses({addresses, responses}), 1000)
            }
          })
      }

      parseAddressData(parsedResponses) {
        return [].concat(...parsedResponses)
          .reduce((acc, address) => {
            acc[address.address] = address
            return acc
          }, {})
      }

      _formatUpdatedTime(time) {
        if (!time) {
          return '-'
        }
        const updatedAt = moment(time)
        if (updatedAt.isSame(moment(), 'day')) {
          return updatedAt.format('HH:mm')
        } else {
          return updatedAt.format('YYYY-MM-DD HH:mm')
        }
      }

      getBalance(addresses, addressData) {
        return [].concat(addresses)
          .reduce((amount, address) => {
            amount += addressData[address.id] ? addressData[address.id].balance : 0
            return amount
          }, 0)
      }

      _formatBalance(btcFormat, addressChange, addressData) {
        if (!(btcFormat && addressChange && addressData)) {
          return '- ' + (btcFormat ? btcFormat.name : 'BTC')
        }
        const amount = this.getBalance(addressChange.base, addressData)
        return utils.formatBtc({btcFormat, amount})
      }

      _formatPrice(priceData, addressChange, addressData) {
        if (!(priceData && addressChange && addressData)) {
          return '-'
        }
        const currency = Object.keys(priceData)[0]
        const balance = this.getBalance(addressChange.base, addressData)
        const amount = balance / 100000000 * priceData[currency]
        return OSREC.CurrencyFormatter.format(amount, {currency})
      }

      _formatCurrentPrice(priceData) {
        if (!priceData) {
          return ''
        }
        const currency = Object.keys(priceData)[0]
        return OSREC.CurrencyFormatter.format(priceData[currency], {currency})
      }
    }

window.customElements.define(WalletPage.is, WalletPage)
  </script>
</dom-module>
